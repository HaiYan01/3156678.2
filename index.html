<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>新型数学用绘图尺 - 交互式演示平台</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Three.js & OrbitControls -->
  <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.150.1/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.150.1/examples/jsm/"
      }
    }
  </script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
      body {
          font-family: 'Noto Sans SC', sans-serif;
          background-color: #0f172a;
          color: #e2e8f0;
          overflow: hidden; /* Prevent body scroll, handle inside containers */
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
          width: 6px;
          height: 6px;
      }
      ::-webkit-scrollbar-track {
          background: #1e293b;
      }
      ::-webkit-scrollbar-thumb {
          background: #3b82f6;
          border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
          background: #60a5fa;
      }

      .glass-panel {
          background: rgba(30, 41, 59, 0.75);
          backdrop-filter: blur(12px);
          border: 1px solid rgba(148, 163, 184, 0.1);
          box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
      }

      .neon-text {
          text-shadow: 0 0 10px rgba(59, 130, 246, 0.5), 0 0 20px rgba(59, 130, 246, 0.3);
      }

      .btn-active {
          background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
          color: white;
          box-shadow: 0 0 15px rgba(37, 99, 235, 0.4);
          border: 1px solid rgba(255,255,255,0.1);
      }

      .fade-in {
          animation: fadeIn 0.5s ease-out forwards;
      }

      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
      }

      /* Loading Overlay */
      #loader {
          position: fixed;
          top: 0; left: 0; width: 100%; height: 100%;
          background: #020617;
          z-index: 9999;
          display: flex;
          justify-content: center;
          align-items: center;
          flex-direction: column;
          transition: opacity 0.8s ease;
      }
      .spinner {
          width: 50px; height: 50px;
          border: 3px solid rgba(255,255,255,0.1);
          border-radius: 50%;
          border-top-color: #3b82f6;
          animation: spin 1s ease-in-out infinite;
      }
      @keyframes spin {
          to { transform: rotate(360deg); }
      }

      .canvas-container {
          width: 100%;
          height: 100%;
          position: absolute;
          top: 0;
          left: 0;
          z-index: 0;
      }

      .ui-layer {
          position: relative;
          z-index: 10;
          pointer-events: none; /* Let clicks pass through to 3D where needed */
          height: 100vh;
          display: flex;
          flex-direction: column;
      }

      .interactive {
          pointer-events: auto;
      }
  </style>
</head>
<body>

<!-- Loading Screen -->
<div id="loader">
  <div class="spinner mb-4"></div>
  <div class="text-blue-400 font-bold tracking-wider">加载 3D 模型...</div>
</div>

<!-- 3D Canvas Background -->
<div class="canvas-container" id="canvas-container"></div>

<!-- UI Overlay -->
<div class="ui-layer">

  <!-- Header -->
  <header class="w-full glass-panel border-b border-white/10 interactive py-3 px-6 flex justify-between items-center shrink-0">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 rounded bg-blue-600 flex items-center justify-center shadow-[0_0_15px_rgba(37,99,235,0.6)]">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
      </div>
      <div>
        <h1 class="text-xl font-bold text-white tracking-wide neon-text">新型数学用绘图尺</h1>
        <p class="text-xs text-slate-400">Interactive Tool Demo</p>
      </div>
    </div>

    <nav class="hidden md:flex gap-2">
      <button onclick="switchTab('measure')" id="btn-measure" class="px-4 py-1.5 rounded-full text-sm font-medium transition-all hover:bg-white/5 text-slate-300 hover:text-white">测量长度</button>
      <button onclick="switchTab('triangle')" id="btn-triangle" class="px-4 py-1.5 rounded-full text-sm font-medium transition-all hover:bg-white/5 text-slate-300 hover:text-white">绘制三角形</button>
      <button onclick="switchTab('polygon')" id="btn-polygon" class="px-4 py-1.5 rounded-full text-sm font-medium transition-all hover:bg-white/5 text-slate-300 hover:text-white">绘制多边形</button>
      <button onclick="switchTab('arc')" id="btn-arc" class="px-4 py-1.5 rounded-full text-sm font-medium transition-all hover:bg-white/5 text-slate-300 hover:text-white">绘制弧形</button>
    </nav>
  </header>

  <!-- Mobile Nav (Bottom) -->
  <nav class="md:hidden flex justify-around glass-panel interactive absolute bottom-0 w-full pb-safe z-50">
    <button onclick="switchTab('measure')" class="p-3 text-xs flex flex-col items-center text-blue-400"><svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>测量</button>
    <button onclick="switchTab('triangle')" class="p-3 text-xs flex flex-col items-center text-slate-400"><svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21l1.65-3.8a9 9 0 113.95 3.95L7.5 21L3 21z"></path></svg>三角形</button>
    <button onclick="switchTab('polygon')" class="p-3 text-xs flex flex-col items-center text-slate-400"><svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path></svg>多边形</button>
    <button onclick="switchTab('arc')" class="p-3 text-xs flex flex-col items-center text-slate-400"><svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 21a9 9 0 110-18 9 9 0 010 18z"></path></svg>弧形</button>
  </nav>

  <!-- Main Content Grid -->
  <div class="flex-1 flex flex-col md:flex-row overflow-hidden relative">

    <!-- Left/Center: 3D Viewport Area (Invisible but for spacing) -->
    <div class="flex-1 relative pointer-events-none">
      <!-- Floating Tooltip -->
      <div id="part-tooltip" class="absolute hidden bg-black/80 backdrop-blur border border-blue-500/50 text-white text-xs p-3 rounded pointer-events-none transform -translate-x-1/2 -translate-y-full mb-2 z-50 max-w-[200px]">
        <h4 class="font-bold text-blue-400 mb-1" id="tooltip-title">部件名称</h4>
        <p id="tooltip-desc">描述内容...</p>
      </div>

      <!-- 3D Controls Overlay -->
      <div class="absolute bottom-6 left-6 pointer-events-none">
        <div class="text-slate-400 text-sm font-light bg-black/40 px-3 py-1 rounded backdrop-blur border border-white/5">
          <span class="text-blue-400 font-bold">操作提示：</span> 鼠标左键旋转 · 滚轮缩放 · 右键平移 · 点击部件查看详情
        </div>
      </div>
    </div>

    <!-- Right: Info/Control Panel -->
    <aside class="w-full md:w-[480px] h-1/2 md:h-full glass-panel interactive flex flex-col border-l border-white/10 transition-transform duration-500 translate-x-0" id="info-panel">

      <!-- Panel Header -->
      <div class="p-4 border-b border-white/10 flex justify-between items-center bg-black/20">
        <h2 id="panel-title" class="text-lg font-bold text-white flex items-center gap-2">
          <span class="w-1 h-5 bg-blue-500 rounded-full"></span>
          功能介绍
        </h2>
        <button onclick="togglePanel()" class="text-slate-400 hover:text-white">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
        </button>
      </div>

      <!-- Panel Content -->
      <div class="flex-1 overflow-y-auto p-5 space-y-6" id="panel-content">
        <!-- Dynamic Content Injected Here -->
      </div>

      <!-- Panel Footer -->
      <div class="p-4 border-t border-white/10 bg-black/20">
        <div class="flex gap-3 justify-center">
          <button onclick="switchTab('guide')" class="text-xs text-slate-400 hover:text-white underline decoration-dotted">使用指南</button>
          <button onclick="switchTab('faq')" class="text-xs text-slate-400 hover:text-white underline decoration-dotted">常见问题</button>
          <button onclick="alert('请联系客服：zn_1018@qq.com')" class="text-xs text-slate-400 hover:text-white underline decoration-dotted">联系客服</button>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- JS Logic -->
<script type="module">
  import * as THREE from 'three';
  import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

  // --- State Management ---
  const state = {
    currentTab: 'measure', // measure, triangle, polygon, arc, guide, faq
    targetRotationLeft: 0, // Radians
    targetRotationRight: 0,
    extensionLeft: 0,     // 0 to 1
    extensionRight: 0,
    sliderLock: true,     // Whether sliders are locked to main rulers
    boltVisible: true,
    activePart: null
  };

  // --- Content Data ---
  const contentData = {
    measure: {
      title: "测量长度",
      steps: [
        { title: "短距离测量", desc: "直接使用直尺1进行测量，读取直尺上的长度标记。" },
        { title: "长距离测量", desc: "拧下手拧螺栓4，转动两个主尺2，使其与直尺1的一侧面共线。" },
        { title: "读数", desc: "确保主尺2与直尺1完全共线后，读取直尺1和主尺2上的长度标记，两者长度相加即为总测量长度。" }
      ],
      notice: "转动主尺2时，需确保其与半圆形片11的圆心位置转动顺畅，避免卡顿导致测量误差。",
      previewType: "text"
    },
    triangle: {
      title: "绘制三角形",
      steps: [
        { title: "调整边长", desc: "滑动副尺3调整其在主尺2上的位置。副尺3通过T型通槽31与主尺2的T型固定轴22滑动适配，调整后主尺2和副尺3的一侧边重合，确定三角形两条边的长度。" },
        { title: "设定角度", desc: "拉动手拧螺栓4，使得两个主尺2都旋转一定的角度。通过半圆形片11上的角度标记，确定直尺1与两个主尺2之间的夹角。" },
        { title: "绘制", desc: "待边长和夹角确定后，即可沿着直尺1、主尺2和副尺3的侧边绘制三角形。" }
      ],
      params: "此处展示预览区...",
      previewType: "triangle"
    },
    polygon: {
      title: "绘制多边形",
      steps: [
        { title: "解锁副尺", desc: "拧下手拧螺栓4，将副尺3向外伸出，使副尺3的最后端进入主尺2的转动槽23范围，此时副尺3可自由转动。" },
        { title: "确定第一条边", desc: "使用直尺1或主尺2绘制第一条边。" },
        { title: "确定后续边", desc: "转动主尺2确定夹角，调整副尺3长度并绘制第二条边。依次重复，最多可绘制五条边的多边形。" }
      ],
      notice: "每次调整主尺2角度和副尺3长度后，需确保部件连接稳定，再进行绘制，避免线条偏移。",
      previewType: "text"
    },
    arc: {
      title: "绘制弧形",
      steps: [
        { title: "装入笔尖", desc: "拧下手拧螺栓4，将笔尖插入其中一个副尺3的螺纹孔32中。" },
        { title: "调整半径", desc: "滑动副尺3，调整其在主尺2缺槽21内的位置。通过限位块24与限位槽33配合固定，确定弧形半径。" },
        { title: "旋转绘制", desc: "以半圆形片11的圆心为中心点，转动副尺3，笔尖围绕中心点移动，即可绘制出弧形。" }
      ],
      tips: "绘制时保持笔尖垂直于绘图平面，且转动速度均匀，确保弧形线条流畅。",
      previewType: "arc"
    },
    guide: {
      title: "使用指南",
      content: `
                    <div class="space-y-4">
                        <h3 class="text-blue-400 font-bold">结构组成</h3>
                        <ul class="list-disc list-inside text-sm space-y-2 text-slate-300">
                            <li><span class="text-white">直尺1</span>：基础测量主体，两端固定半圆形片。</li>
                            <li><span class="text-white">半圆形片11</span>：带有角度标记，作为旋转圆心。</li>
                            <li><span class="text-white">主尺2</span>：转动连接在直尺两端，内部有缺槽。</li>
                            <li><span class="text-white">副尺3</span>：滑动安装在主尺上，可伸缩和旋转。</li>
                            <li><span class="text-white">手拧螺栓4</span>：连接副尺，用于锁定形状。</li>
                        </ul>
                    </div>
                `,
      previewType: "text"
    },
    faq: {
      title: "常见问题",
      questions: [
        { q: "主尺转动不顺畅怎么办？", a: "检查主尺与半圆形片的连接部位是否有异物堵塞，轻轻擦拭连接点即可。" },
        { q: "绘制弧形时半径无法固定？", a: "确保副尺的限位槽与主尺的限位块完全卡合，调整时用力到位。" },
        { q: "手拧螺栓丢失了？", a: "可联系客服咨询配件。暂时无螺栓时，可先完成无需螺栓的功能操作。" }
      ],
      previewType: "accordion"
    }
  };

  const partsInfo = {
    "StraightRuler": { title: "直尺 1", desc: "基础测量构件，刻度标记清晰，两端连接半圆片。", color: 0x64748b },
    "Protractor": { title: "半圆形片 11", desc: "带有角度标记，作为主尺旋转的圆心参考。", color: 0x3b82f6 },
    "MainRuler": { title: "主尺 2", desc: "可绕半圆片圆心转动，内设缺槽供副尺滑动。", color: 0x94a3b8 },
    "AuxRuler": { title: "副尺 3", desc: "滑动安装在主尺上，可伸长或进入转动槽自由旋转。", color: 0xf59e0b },
    "Bolt": { title: "手拧螺栓 4", desc: "连接两个副尺的端部，用于固定整体形状。", color: 0xef4444 }
  };

  // --- Three.js Setup ---
  const container = document.getElementById('canvas-container');
  const scene = new THREE.Scene();
  // Fog for depth
  scene.fog = new THREE.FogExp2(0x0f172a, 0.02);

  const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
  camera.position.set(0, 15, 20);

  const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  container.appendChild(renderer.domElement);

  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.05;
  controls.maxPolarAngle = Math.PI / 2;

  // Lighting
  const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
  scene.add(ambientLight);

  const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
  dirLight.position.set(10, 20, 10);
  dirLight.castShadow = true;
  dirLight.shadow.mapSize.width = 2048;
  dirLight.shadow.mapSize.height = 2048;
  scene.add(dirLight);

  const blueSpot = new THREE.PointLight(0x3b82f6, 0.5);
  blueSpot.position.set(0, 10, 0);
  scene.add(blueSpot);

  // Materials
  const plasticMat = new THREE.MeshStandardMaterial({ color: 0x94a3b8, roughness: 0.2, metalness: 0.1 });
  const rulerBaseMat = new THREE.MeshStandardMaterial({ color: 0xe2e8f0, roughness: 0.1, metalness: 0.0 });
  const accentMat = new THREE.MeshStandardMaterial({ color: 0x3b82f6, roughness: 0.2, metalness: 0.3 });
  const boltMat = new THREE.MeshStandardMaterial({ color: 0xef4444, roughness: 0.4, metalness: 0.5 });

  // --- Ruler Construction ---
  const rulerGroup = new THREE.Group();
  scene.add(rulerGroup);

  // 1. Straight Ruler (直尺 1)
  const rulerGeo = new THREE.BoxGeometry(12, 0.5, 1.5);
  const ruler1 = new THREE.Mesh(rulerGeo, rulerBaseMat);
  ruler1.castShadow = true;
  ruler1.receiveShadow = true;
  ruler1.userData = { type: 'StraightRuler' };
  rulerGroup.add(ruler1);

  // Add markings to Straight Ruler
  const markingsGroup = new THREE.Group();
  ruler1.add(markingsGroup);
  for(let i=0; i<=24; i++) {
    const h = (i%5===0) ? 0.6 : 0.3;
    const mGeo = new THREE.BoxGeometry(0.05, 0.55, h);
    const m = new THREE.Mesh(mGeo, new THREE.MeshBasicMaterial({color: 0x000000}));
    m.position.set(-6 + i*0.5, 0, 0);
    markingsGroup.add(m);
  }

  // 2. Protractors (半圆形片 11)
  function createProtractor() {
    const group = new THREE.Group();
    // Base disk
    const baseGeo = new THREE.CylinderGeometry(1.6, 1.6, 0.2, 32);
    const base = new THREE.Mesh(baseGeo, accentMat);
    base.rotation.x = Math.PI / 2;
    base.position.y = 0.35; // Slightly above ruler
    base.userData = { type: 'Protractor' };
    group.add(base);

    // Ticks (visual only)
    const tickGeo = new THREE.BoxGeometry(0.05, 0.2, 0.1);
    for(let i=0; i<=180; i+=10) {
      const tick = new THREE.Mesh(tickGeo, new THREE.MeshBasicMaterial({color: 0xffffff}));
      tick.rotation.z = (i * Math.PI / 180);
      tick.position.x = Math.sin(tick.rotation.z) * 1.4;
      tick.position.y = 0.35;
      tick.position.z = Math.cos(tick.rotation.z) * 1.4;
      group.add(tick);
    }
    return group;
  }

  const protractorL = createProtractor();
  protractorL.position.set(-6, 0, 0);
  rulerGroup.add(protractorL);

  const protractorR = createProtractor();
  protractorR.position.set(6, 0, 0);
  rulerGroup.add(protractorR);

  // 3. Main Rulers (主尺 2) & 4. Aux Rulers (副尺 3)
  function createArmSide(isLeft) {
    const pivotX = isLeft ? -6 : 6;
    const dir = isLeft ? 1 : -1; // Direction of movement

    // Pivot Group
    const pivot = new THREE.Group();
    pivot.position.set(pivotX, 0.1, 0); // Rotates at protractor center
    rulerGroup.add(pivot);

    // Main Ruler
    const mainRulerGeo = new THREE.BoxGeometry(5, 0.3, 0.8);
    const mainRuler = new THREE.Mesh(mainRulerGeo, plasticMat);
    mainRuler.position.set(2.5 * dir, 0, 0); // Offset so pivot is at 0,0,0 of local space
    mainRuler.userData = { type: 'MainRuler' };
    mainRuler.castShadow = true;
    pivot.add(mainRuler);

    // Main Ruler markings
    const mainMarks = new THREE.Group();
    mainRuler.add(mainMarks);
    for(let i=0; i<10; i++) {
      const mGeo = new THREE.BoxGeometry(0.05, 0.31, 0.3);
      const m = new THREE.Mesh(mGeo, new THREE.MeshBasicMaterial({color: 0xffffff}));
      m.position.set(0.5 + i*0.5, 0, 0);
      mainMarks.add(m);
    }

    // Slot (Visual representation of 缺槽)
    const slotGeo = new THREE.BoxGeometry(3.5, 0.32, 0.3);
    const slot = new THREE.Mesh(slotGeo, new THREE.MeshStandardMaterial({color: 0x1e293b}));
    slot.position.set(2.5 * dir, 0.01, 0); // Slightly on top
    mainRuler.add(slot);

    // Aux Ruler
    const auxGeo = new THREE.BoxGeometry(3, 0.28, 0.7);
    const auxRuler = new THREE.Mesh(auxGeo, new THREE.MeshStandardMaterial({color: 0xf59e0b}));
    auxRuler.userData = { type: 'AuxRuler' };
    auxRuler.castShadow = true;

    // Aux is child of Main for sliding, but we need to rotate it independently for "Polygon" mode later.
    // For simplicity in this demo, Aux is child of Main initially.
    // Initial Position: Extended a bit
    auxRuler.position.set(1.5 * dir, 0, 0);
    mainRuler.add(auxRuler);

    // Aux markings
    const auxMarks = new THREE.Group();
    auxRuler.add(auxMarks);
    for(let i=0; i<6; i++) {
      const mGeo = new THREE.BoxGeometry(0.05, 0.29, 0.2);
      const m = new THREE.Mesh(mGeo, new THREE.MeshBasicMaterial({color: 0x000000}));
      m.position.set(0.5 + i*0.5, 0, 0);
      auxMarks.add(m);
    }

    return { pivot, mainRuler, auxRuler };
  }

  const armLeft = createArmSide(true);
  const armRight = createArmSide(false);

  // 5. Bolt (手拧螺栓 4)
  const boltGroup = new THREE.Group();
  const boltGeo = new THREE.CylinderGeometry(0.15, 0.15, 1, 16);
  const boltMesh = new THREE.Mesh(boltGeo, boltMat);
  boltMesh.rotation.z = Math.PI / 2;
  boltMesh.userData = { type: 'Bolt' };
  boltGroup.add(boltMesh);
  // Handle of bolt
  const handleGeo = new THREE.TorusGeometry(0.25, 0.05, 8, 16);
  const handle = new THREE.Mesh(handleGeo, boltMat);
  handle.position.y = 0.25;
  boltMesh.add(handle);

  // Bolt position is relative to scene, not moving with arms (conceptually it holds the tips of AuxRulers)
  // But in this implementation, let's make it part of the scene and update its position based on AuxRuler tips
  scene.add(boltGroup);


  // --- Ground & Particles ---
  const gridHelper = new THREE.GridHelper(50, 50, 0x1e293b, 0x0f172a);
  gridHelper.position.y = -2;
  scene.add(gridHelper);

  const particleGeo = new THREE.BufferGeometry();
  const particleCount = 200;
  const posArray = new Float32Array(particleCount * 3);
  for(let i=0; i<particleCount*3; i++) {
    posArray[i] = (Math.random() - 0.5) * 30;
  }
  particleGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
  const particleMat = new THREE.PointsMaterial({ size: 0.1, color: 0x3b82f6, transparent: true, opacity: 0.5 });
  const particles = new THREE.Points(particleGeo, particleMat);
  scene.add(particles);


  // --- Logic & Animation ---

  function updateBoltPosition() {
    // Calculate world position of tips of aux rulers
    const leftTip = new THREE.Vector3(1.5, 0, 0); // Tip offset from center of aux
    const rightTip = new THREE.Vector3(-1.5, 0, 0);

    armLeft.auxRuler.localToWorld(leftTip);
    armRight.auxRuler.localToWorld(rightTip);

    // Midpoint
    const midX = (leftTip.x + rightTip.x) / 2;
    const midY = (leftTip.y + rightTip.y) / 2;
    const midZ = (leftTip.z + rightTip.z) / 2;

    boltGroup.position.set(midX, midY, midZ);

    // Rotate bolt to align with the two tips
    boltGroup.lookAt(leftTip);
    boltGroup.rotateX(Math.PI/2);
  }

  const tooltip = document.getElementById('part-tooltip');
  const tooltipTitle = document.getElementById('tooltip-title');
  const tooltipDesc = document.getElementById('tooltip-desc');
  const raycaster = new THREE.Raycaster();
  const mouse = new THREE.Vector2();

  function onMouseClick(event) {
    // Only process if not clicking UI
    if(event.target.closest('.interactive')) return;

    mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

    raycaster.setFromCamera(mouse, camera);
    const intersects = raycaster.intersectObjects(scene.children, true);

    if (intersects.length > 0) {
      // Find first object with userData.type
      const obj = intersects.find(hit => hit.object.userData.type);
      if (obj) {
        showTooltip(obj.object, event.clientX, event.clientY);
        highlightPart(obj.object);
      }
    } else {
      tooltip.classList.add('hidden');
      unhighlightAll();
    }
  }

  function onMouseMove(event) {
    // Hover effect logic could go here
  }

  function showTooltip(obj, x, y) {
    const info = partsInfo[obj.userData.type];
    if(info) {
      tooltipTitle.textContent = info.title;
      tooltipDesc.textContent = info.desc;
      tooltip.style.left = x + 'px';
      tooltip.style.top = y + 'px';
      tooltip.classList.remove('hidden');
    }
  }

  let currentHighlight = null;
  function highlightPart(obj) {
    unhighlightAll();
    if(obj.material.emissive) {
      obj.material.emissive.setHex(0x3b82f6);
      obj.material.emissiveIntensity = 0.5;
      currentHighlight = obj;
    }
  }

  function unhighlightAll() {
    if(currentHighlight) {
      currentHighlight.material.emissive.setHex(0x000000);
      currentHighlight = null;
    }
  }

  window.addEventListener('click', onMouseClick);

  // --- State Transitions ---
  function lerp(start, end, amt) {
    return (1 - amt) * start + amt * end;
  }

  function animateState() {
    // Arm Rotations
    armLeft.pivot.rotation.z = lerp(armLeft.pivot.rotation.z, state.targetRotationLeft, 0.05);
    armRight.pivot.rotation.z = lerp(armRight.pivot.rotation.z, state.targetRotationRight, 0.05);

    // Arm Extensions (Simple x-position lerp for demo)
    // Real logic: sliding along X axis relative to MainRuler
    const targetExtL = 0.5 + (state.extensionLeft * 2); // Min 0.5, Max 2.5
    const targetExtR = -0.5 - (state.extensionRight * 2);

    armLeft.auxRuler.position.x = lerp(armLeft.auxRuler.position.x, targetExtL, 0.05);
    armRight.auxRuler.position.x = lerp(armRight.auxRuler.position.x, targetExtR, 0.05);

    updateBoltPosition();
    boltGroup.visible = state.boltVisible;

    // Bolt rotation (spin slightly for effect)
    if(state.boltVisible) {
      boltMesh.rotation.y += 0.01;
    }
  }

  // --- UI Updates ---
  window.switchTab = function(tabId) {
    state.currentTab = tabId;

    // Update Nav Buttons
    document.querySelectorAll('nav button').forEach(btn => {
      btn.classList.remove('text-white', 'bg-white/10');
      btn.classList.add('text-slate-300');
    });
    const activeBtn = document.getElementById('btn-' + tabId);
    if(activeBtn) {
      activeBtn.classList.add('text-white', 'bg-white/10');
      activeBtn.classList.remove('text-slate-300');
    }

    // Update Content Panel
    const data = contentData[tabId];
    const titleEl = document.getElementById('panel-title');
    const contentEl = document.getElementById('panel-content');

    titleEl.innerHTML = `<span class="w-1 h-5 bg-blue-500 rounded-full"></span> ${data.title}`;

    let html = '';

    // Render Steps
    if (data.steps) {
      html += `<div class="space-y-4 fade-in">`;
      data.steps.forEach((step, idx) => {
        html += `
                        <div class="flex gap-3">
                            <div class="flex-shrink-0 w-6 h-6 rounded-full bg-blue-900/50 text-blue-400 text-xs flex items-center justify-center font-bold border border-blue-800">${idx+1}</div>
                            <div>
                                <h4 class="text-sm font-bold text-white mb-1">${step.title}</h4>
                                <p class="text-sm text-slate-400 leading-relaxed">${step.desc}</p>
                            </div>
                        </div>
                    `;
      });
      html += `</div>`;
    }

    // Render Params/Preview (Simulated)
    if (data.params) {
      html += `
                    <div class="mt-6 p-4 bg-slate-800/50 rounded border border-slate-700 fade-in" style="animation-delay: 0.2s">
                        <h4 class="text-xs font-bold text-blue-400 mb-2 uppercase">参数设置预览</h4>
                        <div class="flex gap-2 text-xs text-slate-300">
                             <span class="px-2 py-1 bg-slate-700 rounded">角度: 45°</span>
                             <span class="px-2 py-1 bg-slate-700 rounded">边A: 5cm</span>
                             <span class="px-2 py-1 bg-slate-700 rounded">边B: 5cm</span>
                        </div>
                        <div class="mt-3 h-20 bg-slate-900 rounded flex items-center justify-center text-slate-600 text-xs border border-slate-700 dashed">
                            [2D Drawing Preview Placeholder]
                        </div>
                    </div>
                `;
    }

    // Render Accordion (FAQ)
    if (data.questions) {
      html += `<div class="space-y-3 fade-in">`;
      data.questions.forEach((q, idx) => {
        html += `
                        <details class="group bg-slate-800/30 rounded border border-slate-700/50">
                            <summary class="flex justify-between items-center font-medium cursor-pointer list-none p-3 text-sm text-slate-200 hover:text-white transition">
                                <span>${q.q}</span>
                                <span class="transition group-open:rotate-180">
                                    <svg fill="none" height="20" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="20"><path d="M6 9l6 6 6-6"></path></svg>
                                </span>
                            </summary>
                            <div class="text-slate-400 text-xs px-3 pb-3 leading-relaxed border-t border-slate-700/50 pt-2 mt-1">
                                ${q.a}
                            </div>
                        </details>
                    `;
      });
      html += `</div>`;
    }

    // Render Content (Guide)
    if (data.content) {
      html += `<div class="fade-in">${data.content}</div>`;
    }

    // Render Notices/Tips
    if (data.notice) {
      html += `
                    <div class="mt-6 p-3 bg-yellow-900/20 border border-yellow-700/50 rounded flex gap-3 fade-in" style="animation-delay: 0.3s">
                        <svg class="w-5 h-5 text-yellow-500 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <div>
                            <h5 class="text-xs font-bold text-yellow-500 mb-1">注意事项</h5>
                            <p class="text-xs text-yellow-200/80">${data.notice}</p>
                        </div>
                    </div>
                `;
    }
    if (data.tips) {
      html += `
                    <div class="mt-6 p-3 bg-blue-900/20 border border-blue-700/50 rounded flex gap-3 fade-in" style="animation-delay: 0.3s">
                        <svg class="w-5 h-5 text-blue-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        <div>
                            <h5 class="text-xs font-bold text-blue-400 mb-1">操作技巧</h5>
                            <p class="text-xs text-blue-200/80">${data.tips}</p>
                        </div>
                    </div>
                `;
    }

    contentEl.innerHTML = html;

    // --- Set 3D Model Target State ---
    switch(tabId) {
      case 'measure':
        state.targetRotationLeft = 0;
        state.targetRotationRight = 0; // 0 is straight line in local, actually 0 is aligned with straight ruler
        state.extensionLeft = 0.8;
        state.extensionRight = 0.8;
        state.boltVisible = false; // User unscrews it
        break;
      case 'triangle':
        state.targetRotationLeft = Math.PI / 4; // 45 deg
        state.targetRotationRight = -Math.PI / 4;
        state.extensionLeft = 0.5;
        state.extensionRight = 0.5;
        state.boltVisible = true;
        break;
      case 'polygon':
        state.targetRotationLeft = Math.PI / 3; // 60 deg
        state.targetRotationRight = -Math.PI / 3;
        state.extensionLeft = 1.0;
        state.extensionRight = 0.2;
        state.boltVisible = false;
        break;
      case 'arc':
        state.targetRotationLeft = 0;
        state.targetRotationRight = 0; // Straighten one side? Or use both?
        // Let's straighten one and extend for drawing
        state.targetRotationLeft = 0.1;
        state.targetRotationRight = 0;
        state.extensionLeft = 0.0; // Fully retracted
        state.extensionRight = 0.8; // Extended for radius
        state.boltVisible = false;
        break;
    }
  };

  // --- Render Loop ---
  const clock = new THREE.Clock();

  function animate() {
    requestAnimationFrame(animate);
    const time = clock.getElapsedTime();

    controls.update();
    animateState();

    // Subtle float animation for the whole ruler
    rulerGroup.position.y = Math.sin(time * 0.5) * 0.2 - 0.5;

    // Particle movement
    particles.rotation.y = time * 0.05;

    renderer.render(scene, camera);
  }

  // --- Resize Handler ---
  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  // --- Init ---
  // Hide loader after a brief moment
  window.onload = () => {
    setTimeout(() => {
      document.getElementById('loader').style.opacity = '0';
      setTimeout(() => {
        document.getElementById('loader').style.display = 'none';
        switchTab('measure'); // Default tab
      }, 800);
    }, 1000);
    animate();
  };

</script>
</body>

</html>
